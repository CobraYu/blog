## 开篇词

今年开始厚着脸皮写一些技术文章，大概平均两周能写出一篇。产量不高，一是因为平时上班还是挺忙的，二是不想为了写而写，自己如果没有觉得有趣或是有帮助，是很难写下去的。俗话说的好评论装逼末尾要加后缀，文章牛逼标题要加前缀，所以一直也想写个什么系列，可以给文章标题加个前缀。但是像什么闭包，防抖，基础概念之类的，很多书籍和文档都写得都非常好，我觉得我也写不出什么新花样来。 

其实前端入行几年后感觉自己一个明显的变化是，从菜鸟的时候很多东西不会做，最常担心的是东西做不出来，到现在东西都能做出来，无非就是不同技术的选择组合，最常担心的是实现方式是不是最优的，业内普遍的做法又是什么。所以我更想写一个记录平时工作中解决某个问题或是实现某个功能的系列文章，给有类似功能开发需求的朋友提供个思路，同时也和大家一起分享交流看有没有更好的实现方案。

## 需求说明

为了提高用户访问体验，公司的APP及内嵌H5页面都使用了CDN加速，但是前几天出了一些问题，因为CDN服务商二级节点服务器宕机，导致部分区域的移动用户无法正常访问，由于只是CDN服务器的问题，其实源站地址还是可以访问的。后来又出了一次类似的事，上头就要求我们做一个CDN切换的功能，如果某些用户通过CDN访问出了问题，可以切换为直接访问源站。    
对于我们前端来说，如果html文件和引入的静态资源放在一起，这事其实挺简单。但是问题就在于我们html在一个服务器上，而静态资源在专门的OSS（Object Storage Service，对象存储服务）上，这就有点麻烦了。
____

### 什么是ＣＤＮ

>内容分发网络（英语：Content Delivery Network或Content Distribution Network，缩写：CDN）是指一种透过互联网互相连接的计算机网络系统，利用最靠近每位用户的服务器，更快、更可靠地将音乐、图片、影片、应用程序及其他文件发送给用户，来提供高性能、可扩展性及低成本的网络内容传递给用户。  

上面的文字内容来自维基百科，可能有些书面，简单来说是这样一个过程：  

你有一个文件a.js放在杭州的一台服务器上，然后你有了一个源站地址`hangzhou.oss.com/a.js`，如果你请求这个地址就是从源站拿到a.js文件，但是这个服务器江浙沪可能访问很快，但是在平顶山（我老家，河南一个市）访问就不那么快了，于是我花点钱配置了CDN加速，给了我一个CDN加速地址`cdn.oss.com/a.js`，当我在平顶山访问这个地址时，请求到离我最近的郑州的一台CDN服务器，发现这台服务器上是有这个`a.js`的，也没有过期（缓存命中），于是就可以直接返回。如果这个`a.js`过期或是不存在，则会规划出一条最优线路找到下一个存在`a.js`的CDN服务器或者直接回源站拿取并保存，下一次访问就可以直接返回资源。

CDN服务阿里，腾讯，华为大厂都有在做，还有一些比如网宿，又拍云，七牛等，境外cdn加速据说Akamai（阿卡迈）挺不错。我们公司用的是上面哪一个为了照顾一下他们面子，就不指名了，欢迎大家评论推荐更多优秀的CDN服务商。

### 资源引用路径

通常网页中资源的引用路径有两种，相对路径和绝对路径。

相对路径引入的文件是这样：

```html 
 <!-- html -->
 <!-- 相对路径以 ./或者直接路径名开头 -->
 <link href="./style.css" rel="stylesheet" /> 
```
相对路径相对的是当前页面的路径，假设这个html的访问地址是`www.demo.com`，相当于根路径，引入的css网络请求地址就是`www.demo.com/style.css`.如果这个html的访问地址是`www.demo.com/login`，路径为`/login`,则css网络请求地址为`www.demo.com/login/style.css`。   
相对路径引入资源最后的网路请求可以看做`location.host + location.pathname + 文件路径` 。

绝对路径引入的文件是这样：

```html 
 <!-- html -->
 <!-- 绝对路径以一个/开头，两个通常是省略协议，表示http和https同时支持 -->
 <link href="/style.css" rel="stylesheet" /> 
```
绝对路径引入的资源跟当前页面的路径无关，就是从根路径开始，不管你html的访问地址是`www.demo.com`还是`www.demo.com/login`，上面绝对路径引入的css网络请求都是`www.demo.com/style.css`。  
相对路径引入资源最后的网路请求可以看做`location.host + 文件路径` 

通常不建议网页中使用相对路径引入资源，尤其是现在很多SPA应用都是前端控制路由，相对路径可能会造成很多混乱和麻烦。平时项目开发时可以用相对路径，然后用webpack这样的打包工具通过配置公共路径publicPath，打包时把相对路径替换为绝对路径。vue和react官方脚手架创建的项目，webpack.config默认的公共路径就是`/`，最后打包后的文件中所有的资源路径都是以`/`开头的绝对路径。

### 公共路径
webpack中的一个配置项publicPath叫做公共路径，是项目打包后资源的基础路径，也可以理解为前缀。通常情况下设置为`/`，表示当前访问域名。有的时候，我们会将js，css，图片等静态资源存放另一台服务器上。比如我html放在`www.demo.com`上，但其它资源却放在`oss.demo.com`上。这个时候访问`www.demo.com`，`/style.css`网路请求地址`www.demo.com/style.css`显然是找不到资源的。这时我们就可以通过设置publicPath为`oss.demo.com`，从而在`www.demo.com`的页面中请求到`oss.demo.com`上的资源，说白了就是直接使用一个资源的网络地址。

现在想一下为什么前面说html文件和引入的静态资源放在一起切换CDN这事就简单。很明显，放在一起使用绝对路径，静态资源是跟着访问地址的。以`cdn1.demo.com`访问到html，html中的资源请求就都是`cdn1.demo.com`，你换个`cdn2.demo.com`那资源请求就是`cdn2.demo.com`，相当于自动切换，根本不用我们做什么。但是当我们静态资源和html在不同的服务器，html中的地址就是一个写死的网络地址比如`oss.demo.com/style.css`，你不管是从哪个CDN地址访问到html，css的请求永远都是`oss.demo.com/style.css`。
____

<!-- 对于我们前端项目来说就是将网页中css，js，图片，视频等所有资源请求换掉，API接口如果有需要也可以换掉，但一般来说API接口切换还是比较简单的。 -->

## 方案思路

当时首先想到的一个方案是APP代理请求，因为页面是内嵌在APP里面的，页面的所有网络请求APP都能拦截的到，切换CDN后APP将拦截到的所有网页请求替换为切换后的CDN地址。

切换前：
![](./image/1-1.jpg)
切换后：
![](./image/1-2.jpg)

这个方案的好处是前端网页不用做任何修改，以后如果再添加其它的CDN，也只需要APP端多配置几个代理地址即可，客户端评估了可行性后决定去做。但是他们提出拦截处理了网页的网络请求，可能对APP的性能造成影响，希望我们前端以后能自己实现这个切换。

今天我们所要讨论的就是这个方案的实现。


